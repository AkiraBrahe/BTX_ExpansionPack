using BattleTech;
using System.Collections.Generic;
using System.Linq;

namespace BTX_ExpansionPack.Fixes
{
    internal class BuildingTargetingExploitFix
    {
        [HarmonyPatch(typeof(AttackEvaluator), "MakeAttackOrder")]
        public static class AttackEvaluator_MakeAttackOrder
        {
            private static List<ICombatant> originalEnemyUnits;

            [HarmonyPrefix]
            [HarmonyWrapSafe]
            public static void Prefix(AbstractActor unit)
            {
                if (unit == null || unit.BehaviorTree == null || unit.BehaviorTree.enemyUnits == null)
                    return;

                originalEnemyUnits = [.. unit.BehaviorTree.enemyUnits];

                var enemyMechs = unit.BehaviorTree.enemyUnits
                    .OfType<Mech>()
                    .Where(m => !m.IsDead && !string.IsNullOrEmpty(m.standingOnBuildingGuid))
                    .ToList();

                System.Random rng = new();
                foreach (var mech in enemyMechs)
                {
                    var building = unit.Combat.FindCombatantByGUID(mech.standingOnBuildingGuid, true) as Building;
                    if (building != null)
                    {
                        if (rng.NextDouble() < 1.0)
                        {
                            if (!unit.BehaviorTree.enemyUnits.Contains((ICombatant)building))
                            {
                                unit.BehaviorTree.enemyUnits.Insert(0, (ICombatant)building);
                            }
                        }
                    }
                }
            }

            [HarmonyPostfix]
            [HarmonyWrapSafe]
            public static void Postfix(AbstractActor unit)
            {
                if (originalEnemyUnits != null && unit?.BehaviorTree?.enemyUnits != null)
                {
                    unit.BehaviorTree.enemyUnits.Clear();
                    unit.BehaviorTree.enemyUnits.AddRange(originalEnemyUnits);
                    originalEnemyUnits = null;
                }
            }
        }
    }
}
